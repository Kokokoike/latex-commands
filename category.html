<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category - LaTeX Cmds</title>
    <link rel="icon" href="images/icon_site.svg" type="image/svg+xml" sizes="any">
    <link rel="apple-touch-icon" href="images/icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="js/utils.js"></script>
    <link rel="stylesheet" href="css/style.css">

    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-bottom: 40px;
        }

        .container { width: 90%; max-width: 800px; padding: 20px; margin: auto; margin-top: 0; }
        
        .page-title {
            font-size: var(--main-title-size);
            font-weight: bold;
            color: #333;
            margin: 20px 0 10px 0;
        }

        .section-divider {
            border: 0;
            border-top: 2px solid #eee;
            margin: 20px 0;
        }

        /* ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªç”¨ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« (index.htmlã®nav-cardã¨åŒæ§˜) */
        .nav-card {
            background: #f4f4f9; padding: 20px; border-radius: 8px;
            text-decoration: none; color: #2c3e50; font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee;
            transition: all 0.2s ease; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100px;
        }
        .nav-card:hover {
            transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); border-color: #ddd;
        }
        .nav-card-icon { font-size: 2rem; margin-bottom: 10px; }
        .nav-card-title { font-size: 1rem; }
    </style>
</head>
<body>
    <header class="top-header"></header>

    <div class="container">
        <nav class="breadcrumbs"></nav>
        <h1 class="page-title" id="page-title">ä¸€è¦§</h1>
        <p id="category-desc" style="color:#444; line-height:1.6; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #eee;"></p>

        <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
        <div class="view-controls" id="view-controls"></div>

        <!-- ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã‚’å¼·åˆ¶ã™ã‚‹ãŸã‚ã« grid-view ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ -->
        <div class="main-results-list grid-view" id="category-list"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async function() {
            if (window.renderCommonHeader) renderCommonHeader();

            // --- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ ---
            // ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ (Gridãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
            document.getElementById('view-controls').innerHTML = `
                <button class="view-btn" id="btn-list" title="List View">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="4" y="5" width="3" height="3" rx="1"></rect><rect x="9" y="5" width="10" height="3" rx="1"></rect><rect x="4" y="10" width="3" height="3" rx="1"></rect><rect x="9" y="10" width="10" height="3" rx="1"></rect><rect x="4" y="15" width="3" height="3" rx="1"></rect><rect x="9" y="15" width="10" height="3" rx="1"></rect></svg>
                </button>
                <button class="view-btn active" id="btn-grid" title="Grid View">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="4" y="4" width="7" height="7" rx="1"></rect><rect x="13" y="4" width="7" height="7" rx="1"></rect><rect x="4" y="13" width="7" height="7" rx="1"></rect><rect x="13" y="13" width="7" height="7" rx="1"></rect></svg>
                </button>
            `;

            const btnList = document.getElementById('btn-list');
            const btnGrid = document.getElementById('btn-grid');
            
            function setView(mode) {
                const lists = document.querySelectorAll('.main-results-list');
                lists.forEach(list => {
                    if (mode === 'grid') list.classList.add('grid-view');
                    else list.classList.remove('grid-view');
                });

                if (mode === 'grid') {
                    btnGrid.classList.add('active');
                    btnList.classList.remove('active');
                } else {
                    btnList.classList.add('active');
                    btnGrid.classList.remove('active');
                }
            }
            btnList.addEventListener('click', () => setView('list'));
            btnGrid.addEventListener('click', () => setView('grid'));

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿
            await window.initDatabase();

            const params = new URLSearchParams(window.location.search);
            const catPath = params.get('cat');

            // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆç”Ÿæˆ
            const nav = document.querySelector('.breadcrumbs');
            nav.innerHTML = '<a href="index.html">TOP</a>';
            if (catPath === 'Main') {
                nav.appendChild(document.createTextNode(' > '));
                const span = document.createElement('span');
                span.className = 'current-page-name';
                span.innerText = "ä¸»ãªã‚«ãƒ†ã‚´ãƒªãƒ¼";
                nav.appendChild(span);
            } else if (catPath) {
                const parts = catPath.split('/');
                let accum = "";
                parts.forEach((p, i) => {
                    nav.appendChild(document.createTextNode(' > '));
                    if(i === parts.length - 1) {
                        const span = document.createElement('span');
                        span.className = 'current-page-name';
                        span.innerText = p;
                        nav.appendChild(span);
                    } else {
                        accum += (i>0 ? "/" : "") + p;
                        const a = document.createElement('a');
                        a.href = `category.html?cat=${encodeURIComponent(accum)}`;
                        a.innerText = p;
                        nav.appendChild(a);
                    }
                });
            }

            if (!catPath) {
                document.getElementById('page-title').innerText = "Category Not Specified";
                return;
            }

            // éšå±¤æ¢ç´¢
            let pathArray = [];
            let currentLevel = window.db.structure;
            let currentNode = null;

            if (catPath === 'Main') {
                pathArray = [];
                currentLevel = window.db.structure;
                currentNode = { title: "ä¸»ãªã‚«ãƒ†ã‚´ãƒªãƒ¼", description: "" };
            } else {
                pathArray = catPath.split('/');
                currentNode = { title: pathArray[pathArray.length-1] }; 

                // ãƒ«ãƒ¼ãƒˆã‹ã‚‰æ¢ç´¢
                for (const segment of pathArray) {
                    if (!currentLevel) break;
                    const found = currentLevel.find(c => c.title === segment);
                    if (found) {
                        currentNode = found;
                        currentLevel = found.children || [];
                    } else {
                        currentLevel = []; // è¦‹ã¤ã‹ã‚‰ãªã„
                    }
                }
            }
            
            document.title = `${currentNode.title || 'Category'} - LaTeX Dictionary`;
            document.getElementById('page-title').innerText = currentNode.title || "Not Found";
            document.getElementById('category-desc').innerText = currentNode.description || "";

            const listContainer = document.getElementById('category-list');
            listContainer.innerHTML = '';

            // A. ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚‹å ´åˆ (ãƒ•ã‚©ãƒ«ãƒ€è¡¨ç¤º)
            if (currentLevel.length > 0) {
                // ãƒªã‚¹ãƒˆè¡¨ç¤º (type:big)
                document.getElementById('view-controls').style.display = 'none';
                listContainer.classList.remove('grid-view');

                currentLevel.forEach(child => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.onclick = () => location.href = `category.html?cat=${encodeURIComponent([...pathArray, child.title].join('/'))}`;
                    div.innerHTML = `
                        <div class="list-preview" style="font-size: 2rem;">ğŸ“‚</div>
                        <div class="list-info">
                            <div class="cmd-row">
                                <div class="result-cmd" style="color: #333; font-family: inherit;">${child.title}</div>
                            </div>
                            <div class="result-desc"></div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            } 
            // B. æœ«ç«¯ (ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§è¡¨ç¤º)
            else {
                document.getElementById('view-controls').style.display = 'flex';
                
                // é€†å¼•ãã‚­ãƒ¼ä½œæˆ (" / "åŒºåˆ‡ã‚Š)
                const dbKey = pathArray.join(' / ');
                const cmds = window.db.catToCmd[dbKey] || [];

                if (cmds.length === 0) {
                    listContainer.innerHTML = '<div style="color:#666;">No commands found.</div>';
                } else {
                    cmds.forEach(cmdKey => {
                        const data = window.db.commands[cmdKey];
                        if(!data) return;
                        
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        const safeId = 'preview-' + cmdKey.replace(/[^a-zA-Z0-9]/g, '');
                        
                        div.innerHTML = `
                            <div class="list-preview" id="${safeId}"></div>
                            <div class="list-info">
                                <div class="cmd-row">
                                    <div class="result-cmd">${cmdKey}</div>
                                    <button class="copy-btn-small">Copy</button>
                                </div>
                                <div class="result-desc">${data.description || cmdKey}</div>
                            </div>
                        `;
                        
                        const copyBtn = div.querySelector('.copy-btn-small');
                        copyBtn.onclick = (e) => {
                            e.stopPropagation();
                            window.copyText(copyBtn, cmdKey);
                        };

                        div.onclick = () => { window.location.href = `detail1.html?id=${encodeURIComponent(cmdKey)}`; };
                        listContainer.appendChild(div);
                        window.renderMath(safeId, cmdKey);
                    });
                }
            }
        });
    </script>
</body>
</html>