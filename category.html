<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category - LaTeX Cmds</title>
    <link rel="icon" href="images/icon_site.svg" type="image/svg+xml" sizes="any">
    <link rel="apple-touch-icon" href="images/icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="js/utils.js"></script>
    <link rel="stylesheet" href="css/style.css">

    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-bottom: 40px;
        }

        .container { width: 90%; max-width: 800px; padding: 20px; margin: auto; margin-top: 0; }
        
        .page-title {
            font-size: var(--main-title-size);
            font-weight: bold;
            color: #333;
            margin: 20px 0 10px 0;
        }

        .section-divider {
            border: 0;
            border-top: 2px solid #eee;
            margin: 20px 0;
        }

        /* ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªç”¨ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« (index.htmlã®nav-cardã¨åŒæ§˜) */
        .nav-card {
            background: #f4f4f9; padding: 20px; border-radius: 8px;
            text-decoration: none; color: #2c3e50; font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee;
            transition: all 0.2s ease; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100px;
        }
        .nav-card:hover {
            transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); border-color: #ddd;
        }
        .nav-card-icon { font-size: 2rem; margin-bottom: 10px; }
        .nav-card-title { font-size: 1rem; }
    </style>
</head>
<body>
    <header class="top-header"></header>

    <div class="container">
        <nav class="breadcrumbs"></nav>
        <h1 class="page-title" id="page-title">ä¸€è¦§</h1>
        <p id="category-desc" style="color:#444; line-height:1.6; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #eee;"></p>

        <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
        <div class="view-controls" id="view-controls"></div>

        <!-- ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã‚’å¼·åˆ¶ã™ã‚‹ãŸã‚ã« grid-view ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ -->
        <div class="main-results-list grid-view" id="category-list"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async function() {
            if (window.renderCommonHeader) renderCommonHeader();

            // --- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ ---
            // ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ (Gridãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
            document.getElementById('view-controls').innerHTML = `
                <button class="view-btn" id="btn-list" title="List View">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="4" y="5" width="3" height="3" rx="1"></rect><rect x="9" y="5" width="10" height="3" rx="1"></rect><rect x="4" y="10" width="3" height="3" rx="1"></rect><rect x="9" y="10" width="10" height="3" rx="1"></rect><rect x="4" y="15" width="3" height="3" rx="1"></rect><rect x="9" y="15" width="10" height="3" rx="1"></rect></svg>
                </button>
                <button class="view-btn active" id="btn-grid" title="Grid View">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><rect x="4" y="4" width="7" height="7" rx="1"></rect><rect x="13" y="4" width="7" height="7" rx="1"></rect><rect x="4" y="13" width="7" height="7" rx="1"></rect><rect x="13" y="13" width="7" height="7" rx="1"></rect></svg>
                </button>
            `;

            const btnList = document.getElementById('btn-list');
            const btnGrid = document.getElementById('btn-grid');
            
            function setView(mode) {
                const lists = document.querySelectorAll('.main-results-list');
                lists.forEach(list => {
                    if (mode === 'grid') list.classList.add('grid-view');
                    else list.classList.remove('grid-view');
                });

                if (mode === 'grid') {
                    btnGrid.classList.add('active');
                    btnList.classList.remove('active');
                } else {
                    btnList.classList.add('active');
                    btnGrid.classList.remove('active');
                }
            }
            btnList.addEventListener('click', () => setView('list'));
            btnGrid.addEventListener('click', () => setView('grid'));

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿
            await window.initDatabase();

            const params = new URLSearchParams(window.location.search);
            const catPath = params.get('cat');

            // --- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆç”Ÿæˆ ---
            const nav = document.querySelector('.breadcrumbs');
            nav.innerHTML = '<a href="index.html">TOP</a>';
            
            if (catPath === 'Main') {
                nav.appendChild(document.createTextNode(' > '));
                const span = document.createElement('span');
                span.className = 'current-page-name';
                span.innerText = "ä¸»ãªã‚«ãƒ†ã‚´ãƒªãƒ¼";
                nav.appendChild(span);
            } else if (catPath) {
                const parts = catPath.split('/');
                let accum = "";
                parts.forEach((p, i) => {
                    nav.appendChild(document.createTextNode(' > '));
                    if(i === parts.length - 1) {
                        const span = document.createElement('span');
                        span.className = 'current-page-name';
                        span.innerText = p;
                        nav.appendChild(span);
                    } else {
                        accum += (i>0 ? "/" : "") + p;
                        const a = document.createElement('a');
                        a.href = `category.html?cat=${encodeURIComponent(accum)}`;
                        a.innerText = p;
                        nav.appendChild(a);
                    }
                });
            }

            if (!catPath) {
                document.getElementById('page-title').innerText = "Category Not Specified";
                return;
            }

            // --- éšå±¤æ¢ç´¢ (itemså¯¾å¿œç‰ˆ) ---
            let pathArray = [];
            let currentLevel = window.db.structure;
            let currentNode = null;

            if (catPath === 'Main') {
                pathArray = [];
                // Mainã®å ´åˆã¯ãƒ«ãƒ¼ãƒˆæ§‹é€ ãã®ã‚‚ã®ã‚’itemsã¨ã—ã¦æ‰±ã†
                currentNode = { 
                    title: "ä¸»ãªã‚«ãƒ†ã‚´ãƒªãƒ¼", 
                    description: "", 
                    items: window.db.structure 
                };
            } else {
                pathArray = catPath.split('/');
                // åˆæœŸåŒ–ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆç”¨ï¼‰
                currentNode = { title: pathArray[pathArray.length-1] }; 

                // ãƒ«ãƒ¼ãƒˆã‹ã‚‰é †ã«æ½œã‚‹
                for (const segment of pathArray) {
                    if (!currentLevel) break;
                    
                    // titleãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™
                    const found = currentLevel.find(c => c.title === segment);
                    if (found) {
                        currentNode = found;
                        // æ¬¡ã®éšå±¤ã¸ (children -> items)
                        currentLevel = found.items || [];
                    } else {
                        currentLevel = []; // è¦‹ã¤ã‹ã‚‰ãªã„
                    }
                }
            }
            
            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            document.title = `${currentNode.title || 'Category'} - LaTeX Dictionary`;
            document.getElementById('page-title').innerText = currentNode.title || "Not Found";
            document.getElementById('category-desc').innerText = currentNode.description || "";

            const listContainer = document.getElementById('category-list');
            listContainer.innerHTML = '';

            // items ãŒç„¡ã„ã€ã¾ãŸã¯ç©ºã®å ´åˆ
            if (!currentNode.items || currentNode.items.length === 0) {
                listContainer.innerHTML = '<div style="color:#666;">No items found.</div>';
                return;
            }

            // â˜… åˆ¤å®š: ãƒªã‚¹ãƒˆã®æœ€åˆã®è¦ç´ ãŒ "command" å‹ã‹ã©ã†ã‹
            const isCommandList = currentNode.items[0].type === "command";

            // ----------------------------------------------------
            // A. ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ (ãƒ•ã‚©ãƒ«ãƒ€è¡¨ç¤º)
            // ----------------------------------------------------
            if (!isCommandList) {
                document.getElementById('view-controls').style.display = 'none';
                listContainer.classList.remove('grid-view');

                currentNode.items.forEach(child => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    
                    // æ¬¡ã®ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
                    let nextPath = "";
                    if (catPath === 'Main') {
                        nextPath = child.title;
                    } else {
                        nextPath = [...pathArray, child.title].join('/');
                    }

                    div.onclick = () => location.href = `category.html?cat=${encodeURIComponent(nextPath)}`;
                    
                    div.innerHTML = `
                        <div class="list-preview" style="font-size: 2rem;">ğŸ“‚</div>
                        <div class="list-info">
                            <div class="cmd-row">
                                <div class="result-cmd" style="color: #333; font-family: inherit;">${child.title}</div>
                            </div>
                            <div class="result-desc">${child.description || ""}</div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            } 
            // ----------------------------------------------------
            // B. ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ (æœ«ç«¯è¡¨ç¤º)
            // ----------------------------------------------------
            else {
                document.getElementById('view-controls').style.display = 'flex';
                
                // æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã® items ã‚’ç›´æ¥ãƒ«ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
                currentNode.items.forEach(item => {
                    const cmdKey = item.title;
                    // è©³ç´°DBã‹ã‚‰æƒ…å ±ã‚’å¼•ã
                    const data = window.db.commands[cmdKey];
                    
                    if(!data) return; // DBã«ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

                    const div = document.createElement('div');
                    div.className = 'list-item';
                    const safeId = 'preview-' + cmdKey.replace(/[^a-zA-Z0-9]/g, '');
                    
                    div.innerHTML = `
                        <div class="list-preview" id="${safeId}"></div>
                        <div class="list-info">
                            <div class="cmd-row">
                                <div class="result-cmd">${cmdKey}</div>
                                <button class="copy-btn-small">Copy</button>
                            </div>
                            <div class="result-desc">${data.description || cmdKey}</div>
                        </div>
                    `;
                    
                    const copyBtn = div.querySelector('.copy-btn-small');
                    copyBtn.onclick = (e) => {
                        e.stopPropagation();
                        window.copyText(copyBtn, cmdKey);
                    };

                    div.onclick = () => { window.location.href = `detail1.html?id=${encodeURIComponent(cmdKey)}`; };
                    listContainer.appendChild(div);
                    
                    window.renderMath(safeId, cmdKey);
                });
            }
        });
    </script>
</body>
</html>